{"name":"Copilot Premium Requests Monitor — готовый комплект","type":"code/python","content":"# =============================\n# ФАЙЛ: copilot_cost_monitor.py\n# =============================\n\nimport os\nimport csv\nimport math\nimport json\nimport time\nimport pandas as pd\nfrom datetime import datetime\nfrom dotenv import load_dotenv\nimport requests\n\n# === Загрузка конфигурации ===\nload_dotenv()\n\nCSV_PATH = os.getenv("CSV_PATH", "./copilot_premium_requests.csv")\nPLAN = os.getenv("PLAN", "Business").strip()  # Free | Pro | Pro+ | Business | Enterprise\nSEATS = int(os.getenv("SEATS", "1"))         # кол-во лицензий (сидов) для Business/Enterprise\nBUDGET_USD = float(os.getenv("BUDGET_USD", "0"))  # бюджет на сверхлимит, $/мес\nTHRESHOLDS = [float(x) for x in os.getenv("THRESHOLDS", "0.75,0.9,1.0").split(",")]\n\nTELEGRAM_BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN", "")\nTELEGRAM_CHAT_ID = os.getenv("TELEGRAM_CHAT_ID", "")\n\n# === Биллинг ===\nPREMIUM_PRICE_PER_REQUEST = 0.04  # $/запрос сверх включённого лимита\n\n# === Лимиты по планам (включенные премиум-запросы в месяц) ===\n# Free — 50/m; Pro — 300/m; Pro+ — 1500/m; Business — 300/user/m; Enterprise — 1000/user/m\nPLAN_ALLOWANCE = {\n    "Free": 50,\n    "Pro": 300,\n    "Pro+": 1500,\n    "Business": 300,\n    "Enterprise": 1000,\n}\n\n# === Мультипликаторы моделей (для аналитики/советов) ===\nMODEL_MULTIPLIER = {\n    "GPT-4.1": {"paid_plan_multiplier": 0, "free_multiplier": 1},\n    "GPT-4o": {"paid_plan_multiplier": 0, "free_multiplier": 1},\n    "GPT-5 mini": {"paid_plan_multiplier": 0, "free_multiplier": 1},\n    "GPT-5": {"paid_plan_multiplier": 1, "free_multiplier": None},\n    "Claude Sonnet 3.5": {"paid_plan_multiplier": 1, "free_multiplier": 1},\n    "Claude Sonnet 3.7": {"paid_plan_multiplier": 1, "free_multiplier": None},\n    "Claude Sonnet 3.7 Thinking": {"paid_plan_multiplier": 1.25, "free_multiplier": None},\n    "Claude Sonnet 4": {"paid_plan_multiplier": 1, "free_multiplier": None},\n    "Claude Opus 4.1": {"paid_plan_multiplier": 10, "free_multiplier": None},\n    "Claude Opus 4": {"paid_plan_multiplier": 10, "free_multiplier": None},\n    "Gemini 2.0 Flash": {"paid_plan_multiplier": 0.25, "free_multiplier": 1},\n    "Gemini 2.5 Pro": {"paid_plan_multiplier": 1, "free_multiplier": None},\n    "o3": {"paid_plan_multiplier": 1, "free_multiplier": None},\n    "o4-mini": {"paid_plan_multiplier": 0.33, "free_multiplier": None},\n    "Spark": {"paid_plan_multiplier": 4, "free_multiplier": 4},\n}\n\n# === Утилиты ===\n\ndef send_telegram(msg: str):\n    if not TELEGRAM_BOT_TOKEN or not TELEGRAM_CHAT_ID:\n        return False\n    url = f"https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}/sendMessage"\n    try:\n        r = requests.post(url, json={"chat_id": TELEGRAM_CHAT_ID, "text": msg})\n        return r.status_code == 200\n    except Exception:\n        return False\n\n\ndef detect_columns(header):\n    """ Поддержка разных вариантов CSV от GitHub. Ищем возможные имена колонок. """\n    hl = [h.strip().lower() for h in header]\n\n    def find(*candidates):\n        for c in candidates:\n            if c in hl:\n                return hl.index(c)\n        return None\n\n    idx = {\n        "date": find("date", "day", "timestamp"),\n        "user": find("user", "login", "actor", "username", "member"),\n        "feature": find("feature", "copilot_feature", "type"),\n        "model": find("model", "ai_model"),\n        "requests": find("requests", "request_count", "premium_requests", "count"),\n    }\n    return idx\n\n\ndef load_report(csv_path):\n    rows = []\n    with open(csv_path, newline='', encoding="utf-8-sig") as f:\n        reader = csv.reader(f)\n        header = next(reader)\n        idx = detect_columns(header)\n        required = ["date", "user", "feature", "requests"]\n        if any(idx[k] is None for k in required):\n            raise RuntimeError(f"Не распознал колонки CSV. Нашёл: {header}")\n        for r in reader:\n            try:\n                date = r[idx["date"]]\n                user = r[idx["user"]]\n                feature = r[idx["feature"]]\n                model = r[idx["model"]] if idx["model"] is not None else ""\n                reqs = int(r[idx["requests"]])\n                rows.append({"date": date, "user": user, "feature": feature, "model": model, "requests": reqs})\n            except Exception:\n                # пропускаем битые строки\n                continue\n    return rows\n\n\ndef allowance_for(plan: str, seats: int) -> int:\n    base = PLAN_ALLOWANCE.get(plan, 300)\n    if plan in ("Business", "Enterprise"):\n        return base * max(1, seats)\n    else:\n        return base\n\n\ndef analyze(rows, plan, seats, budget_usd):\n    df = pd.DataFrame(rows)\n    total_requests = int(df["requests"].sum()) if not df.empty else 0\n    monthly_allowance = allowance_for(plan, seats)\n    overage_requests = max(0, total_requests - monthly_allowance)\n    overage_cost = overage_requests * PREMIUM_PRICE_PER_REQUEST\n\n    by_user = df.groupby("user")["requests"].sum().reset_index().sort_values("requests", ascending=False) if not df.empty else pd.DataFrame(columns=["user","requests"])\n    by_model = df.groupby("model")["requests"].sum().reset_index().sort_values("requests", ascending=False) if

750# 

